# This Docker Compose file creates a simulated multi-node edge computing cluster
# for testing OTTO orchestration and migration strategies.
version: "3.8"

services:
  mqtt-broker:
    image: eclipse-mosquitto:2.0
    container_name: otto-mqtt-broker
    ports:
      - "1883:1883" # MQTT
      - "9001:9001" # WebSocket
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mqtt-data:/mosquitto/data
      - mqtt-logs:/mosquitto/log
    networks:
      - otto-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "mosquitto_sub",
          "-t",
          "$$SYS/#",
          "-C",
          "1",
          "-i",
          "healthcheck",
          "-W",
          "3",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  edge-node-01:
    image: docker:24-dind
    container_name: otto-edge-node-01
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=/certs
      - NODE_ID=edge-node-01
      - NODE_HOSTNAME=edge-01
    volumes:
      - edge-node-01-docker:/var/lib/docker
      - edge-node-01-certs:/certs
      - migration-data:/migration # Shared volume for migration testing
    ports:
      - "2375:2375" # Docker daemon (insecure for testing only)
      - "2376:2376" # Docker daemon (TLS)
    networks:
      otto-network:
        ipv4_address: 172.20.0.11
    command:
      [
        "dockerd",
        "--host=tcp://0.0.0.0:2375",
        "--host=unix:///var/run/docker.sock",
        "--tls=false",
      ]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    # Resource limits to simulate edge device constraints
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 1G

  edge-node-02:
    image: docker:24-dind
    container_name: otto-edge-node-02
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=/certs
      - NODE_ID=edge-node-02
      - NODE_HOSTNAME=edge-02
    volumes:
      - edge-node-02-docker:/var/lib/docker
      - edge-node-02-certs:/certs
      - migration-data:/migration
    ports:
      - "2377:2375"
      - "2378:2376"
    networks:
      otto-network:
        ipv4_address: 172.20.0.12
    command:
      [
        "dockerd",
        "--host=tcp://0.0.0.0:2375",
        "--host=unix:///var/run/docker.sock",
        "--tls=false",
      ]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 1G

  edge-node-03:
    image: docker:24-dind
    container_name: otto-edge-node-03
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=/certs
      - NODE_ID=edge-node-03
      - NODE_HOSTNAME=edge-03
    volumes:
      - edge-node-03-docker:/var/lib/docker
      - edge-node-03-certs:/certs
      - migration-data:/migration
    ports:
      - "2379:2375"
      - "2380:2376"
    networks:
      otto-network:
        ipv4_address: 172.20.0.13
    command:
      [
        "dockerd",
        "--host=tcp://0.0.0.0:2375",
        "--host=unix:///var/run/docker.sock",
        "--tls=false",
      ]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 1G

networks:
  otto-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
    driver_opts:
      com.docker.network.bridge.name: otto-bridge

volumes:
  # MQTT broker data
  mqtt-data:
    driver: local
  mqtt-logs:
    driver: local

  # Edge node Docker storage
  edge-node-01-docker:
    driver: local
  edge-node-01-certs:
    driver: local

  edge-node-02-docker:
    driver: local
  edge-node-02-certs:
    driver: local

  edge-node-03-docker:
    driver: local
  edge-node-03-certs:
    driver: local

  # Shared migration data volume
  migration-data:
    driver: local
# Accessing edge nodes:
# - Node 1: docker -H tcp://localhost:2375 ps
# - Node 2: docker -H tcp://localhost:2377 ps
# - Node 3: docker -H tcp://localhost:2379 ps
#
# MQTT broker:
# - Broker URL: mqtt://localhost:1883
# - Test publish: mosquitto_pub -h localhost -t test -m "hello"
# - Test subscribe: mosquitto_sub -h localhost -t test
#
# Migration testing:
# - All nodes share /migration volume for testing export/import
# - Use this to transfer container tarballs between nodes
#
# Resource limits:
# - Each node limited to 2 CPUs and 4GB RAM
# - Simulates constrained edge device resources
# - Adjust in deploy.resources.limits as needed
